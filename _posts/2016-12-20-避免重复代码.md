---
layout:     post
title:      "避免重复代码"
subtitle:   ""
date:       2016-12-20 15:00:00
author:     "donkey"
header-img: "img/in-post/default-bg.jpg"
tags:
    - 开发笔记
---

  最近大家都在忙着改BUG，而我却比较闲，开发的模块没有什么BUG，决定抽些时间改下正在开发项目中的一些坏代码
  
```
 message SC_ResponseMsgProto {
	optional LoginResultProto              loginResult              = 1;  // 登陆
	optional RoleBaseInfoProto             roleBaseInfoProto        = 2; // 玩家信息
	...
}
```
  
  项目客户端和服务器采用的是Google的protobuf协议，数据结构如上。SC_ResponseMsgProto是最外层对象，在最外层对象下有多个不同类别的子对象，子对象下还拥有一些不同类别的子对象，最终成为一个森林结构，森林里每个根对象都是一颗树。这样的设计在开发中是比较常见的，但是在使用上比较简单，大量的对象重复出现在项目中。对于每个程序员员来说，避免重复代码是大家都想做的。我大约花了不到30行代码对其做了些修改，代码如下：
  
```
    /**
     * 下发给客户端的消息
     */
    private final LinkedList<GeneratedMessageLite> responseMsgs = new LinkedList<>();
    
    //添加消息
    public void putMsg(GeneratedMessageLite msg) {
        synchronized (responseMsgs) {
            responseMsgs.add(msg);
        }
    }
    
    //发送消息
    public void sendMsg(Channel channel) {
        //和客户端通讯的数据
        SC_ResponseMsgProto.Builder responseMsgBuilder = SC_ResponseMsgProto.newBuilder();
        try {
            for (GeneratedMessageLite messageLite : responseMsgs) 
            {
               if (messageLite instanceof CharacterOperateResult) {
                    responseMsgBuilder.setCharacterOperateResult((CharacterOperateResult) messageLite);
                }
            }
            sendMsgToClient(channel, responseMsgBuilder.build());
        }catch (Exception e) {
            e.printStackTrace();
            logger.error(e.getMessage(), e);
        } finally {
            responseMsgs.clear();
        }
        
    }

```


  
  